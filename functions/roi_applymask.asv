function roi_stack = roi_applymask(stack, mask)
    [rows, cols] = find(mask);
    ymin = min(rows);    ymax = max(rows);
    xmin = min(cols);    xmax = max(cols);
    %
    cropstack = stack(ymin:ymax, xmin:xmax, :);
    cropmask = mask(ymin:ymax, xmin:xmax);
    


    % Preallocate result
    roi_stack = stack.*mask; % mask broadcasted to z axis
    roi_stack(~mask) = NaN; % mask broadcasted to z axis
    % Crop to bounding box
    roi_stack = roi_stack(ymin:ymax, xmin:xmax, :);
end
